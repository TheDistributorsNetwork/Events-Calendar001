<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Members Area</title>
<style>
body{
  font-family:Arial;
  margin:0;
  padding:40px;
  background:#002147;
  color:#fff;
  text-align:center;
}
h1,h2,h3{color:#FFD700;}
.container{
  max-width:1100px;
  margin:auto;
  background:#1a1a1a;
  padding:30px;
  border-radius:12px;
}
input, select { width:100%; padding:8px; margin:6px 0; }
.btn{background:#FFD700;color:#000;border:none;padding:8px 14px;border-radius:6px;cursor:pointer;font-weight:bold;margin:4px;}
.btn-danger{background:#800000;color:#fff;}
.member-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(230px,1fr));gap:20px;margin-top:20px;}
.member-card{background:#262626;padding:15px;border-radius:10px;text-align:center;}
.member-card img{width:100%;height:220px;object-fit:cover;border-radius:8px;}
hr{margin:25px 0;}
</style>
</head>
<body>
<div class="container">
<h1>Members Area</h1>

<!-- LOGIN -->
<div id="loginStage">
<h2>Login</h2>
<input id="username" placeholder="Username">
<input id="password" type="password" placeholder="Password">
<button class="btn" onclick="login()">Login</button>
<br>
<a href="index.html" class="btn">Back to Calendar</a>
</div>

<!-- MEMBERS -->
<div id="membersStage" style="display:none;">
<button class="btn" onclick="logout()">Logout</button>

<!-- ADMIN CONTROLS -->
<div id="adminControls" style="display:none;">

<h3>Add / Edit Member</h3>
<input id="mName" placeholder="Name">
<input id="mSurname" placeholder="Surname">
<input id="mNumber" placeholder="Member Number">
<input id="mTitle" placeholder="Title">
<input id="mPhoto" type="file" accept="image/*">

<h4>Visibility & Permissions</h4>
<label><input type="checkbox" id="vName" checked> Show Name</label><br>
<label><input type="checkbox" id="vSurname" checked> Show Surname</label><br>
<label><input type="checkbox" id="vTitle" checked> Show Title</label><br>
<label><input type="checkbox" id="vNumber" checked> Show Number</label><br>
<label><input type="checkbox" id="vPhoto" checked> Show Photo</label><br>
<label><input type="checkbox" id="vRequestEvent"> Can Request Event</label><br>

<button class="btn" onclick="saveMember()">Save Member</button>
<hr>

<h3>User Management</h3>
<input id="newUsername" placeholder="Username">
<input id="newPassword" placeholder="Password">
<select id="newRole">
<option value="member">Member</option>
<option value="admin">Admin</option>
</select>
<label><input type="checkbox" id="newCanRequest"> Can Request Event</label>
<button class="btn" onclick="saveUser()">Save User</button>

<div id="userList"></div>

<hr>
<h3>Pending Event Requests</h3>
<div id="pendingList"></div>

<hr>
<h3>Approved Events</h3>
<div id="approvedList"></div>

</div>

<div class="member-grid" id="memberGrid"></div>
</div>

<script>

/* ---------------- STORAGE ---------------- */

function getUsers(){ return JSON.parse(localStorage.getItem("users")||"{}"); }
function saveUsers(u){ localStorage.setItem("users",JSON.stringify(u)); }
function getMembers(){ return JSON.parse(localStorage.getItem("members")||"[]"); }
function saveMembers(m){ localStorage.setItem("members",JSON.stringify(m)); }
function getPending(){ return JSON.parse(localStorage.getItem("pendingEvents")||"[]"); }
function savePending(p){ localStorage.setItem("pendingEvents",JSON.stringify(p)); }
function getApproved(){ return JSON.parse(localStorage.getItem("approvedEvents")||"[]"); }
function saveApproved(a){ localStorage.setItem("approvedEvents",JSON.stringify(a)); }

/* INIT ADMIN1 ONLY */
if(!localStorage.getItem("users")){
  saveUsers({
    admin1:{password:"admin123",role:"admin",active:true,canRequestEvent:true}
  });
}

let role=null;
let currentUser=null;
let editingMemberId=null;

/* ---------------- LOGIN ---------------- */

function login(){
  const users=getUsers();
  const user=users[username.value];

  if(user && user.password===password.value && user.active){
    role=user.role;
    currentUser=username.value;
    loginStage.style.display="none";
    membersStage.style.display="block";
    adminControls.style.display=role==="admin"?"block":"none";
    if(role==="admin"){
      loadUsers();
      loadPending();
      loadApproved();
    }
    loadMembers();
  } else alert("Invalid or disabled account");
}

function logout(){
  role=null;
  currentUser=null;
  membersStage.style.display="none";
  loginStage.style.display="block";
}

/* ---------------- USER MANAGEMENT ---------------- */

function saveUser(){
  const users=getUsers();

  if(newUsername.value==="admin1"){
    alert("admin1 cannot be modified");
    return;
  }

  users[newUsername.value]={
    password:newPassword.value,
    role:newRole.value,
    active:true,
    canRequestEvent:newCanRequest.checked
  };

  saveUsers(users);
  newUsername.value=""; newPassword.value=""; newRole.value="member"; newCanRequest.checked=false;
  loadUsers();
}

function editUser(username){
  if(username==="admin1") return;
  const users=getUsers();
  const u=users[username];
  newUsername.value=username;
  newPassword.value=u.password;
  newRole.value=u.role;
  newCanRequest.checked=u.canRequestEvent;
}

function deleteUser(username){
  if(username==="admin1") return;
  const users=getUsers();
  delete users[username];
  saveUsers(users);
  loadUsers();
}

function toggleUser(username){
  if(username==="admin1") return;
  const users=getUsers();
  users[username].active=!users[username].active;
  saveUsers(users);
  loadUsers();
}

function loadUsers(){
  const users=getUsers();
  let html="<h4>Existing Users</h4>";
  Object.keys(users).forEach(u=>{
    html+=`<div>
      <strong>${u}</strong> (${users[u].role}) - ${users[u].active?"Active":"Disabled"}
      ${u!=="admin1"?`
      <button class="btn" onclick="editUser('${u}')">Edit</button>
      <button class="btn btn-danger" onclick="toggleUser('${u}')">${users[u].active?"Disable":"Enable"}</button>
      <button class="btn btn-danger" onclick="deleteUser('${u}')">Delete</button>
      `:""}
    </div>`;
  });
  userList.innerHTML=html;
}

/* ---------------- MEMBER MANAGEMENT ---------------- */

function saveMember(){
  const members=getMembers();

  const memberData={
    id: editingMemberId || Date.now(),
    name:mName.value.trim(),
    surname:mSurname.value.trim(),
    number:mNumber.value.trim(),
    title:mTitle.value.trim(),
    visibility:{
      name:vName.checked,
      surname:vSurname.checked,
      title:vTitle.checked,
      number:vNumber.checked,
      photo:vPhoto.checked,
      canRequestEvent:vRequestEvent.checked
    }
  };

  if(mPhoto.files[0]){
    const reader=new FileReader();
    reader.onload=function(){ memberData.photo=reader.result; commitMember(memberData); };
    reader.readAsDataURL(mPhoto.files[0]);
  } else {
    const existing=members.find(m=>m.id===editingMemberId);
    memberData.photo=existing?existing.photo:"";
    commitMember(memberData);
  }
}

function commitMember(memberData){
  let members=getMembers();
  if(editingMemberId)
    members=members.map(m=>m.id===editingMemberId?memberData:m);
  else
    members.push(memberData);

  saveMembers(members);
  editingMemberId=null;
  clearForm();
  loadMembers();
}

function editMember(id){
  const m=getMembers().find(x=>x.id===id);
  editingMemberId=id;
  mName.value=m.name;
  mSurname.value=m.surname;
  mNumber.value=m.number;
  mTitle.value=m.title;
  vName.checked=m.visibility.name;
  vSurname.checked=m.visibility.surname;
  vTitle.checked=m.visibility.title;
  vNumber.checked=m.visibility.number;
  vPhoto.checked=m.visibility.photo;
  vRequestEvent.checked=m.visibility.canRequestEvent;
}

function deleteMember(id){
  const members=getMembers().filter(m=>m.id!==id);
  saveMembers(members);
  loadMembers();
}

function clearForm(){
  mName.value=""; mSurname.value=""; mNumber.value=""; mTitle.value=""; mPhoto.value="";
  vName.checked=true; vSurname.checked=true; vTitle.checked=true; vNumber.checked=true; vPhoto.checked=true; vRequestEvent.checked=false;
}

/* ---------------- EVENT APPROVAL ---------------- */

function loadPending(){
  pendingList.innerHTML="";
  getPending().forEach((e,i)=>{
    pendingList.innerHTML+=`
    <div>
      ${e.title} - ${e.date}
      <button class="btn" onclick="approveEvent(${i})">Approve</button>
      <button class="btn btn-danger" onclick="rejectEvent(${i})">Reject</button>
    </div>`;
  });
}

function approveEvent(i){
  const pending=getPending();
  const approved=getApproved();
  approved.push(pending[i]);
  pending.splice(i,1);
  savePending(pending);
  saveApproved(approved);
  loadPending();
  loadApproved();
}

function rejectEvent(i){
  const pending=getPending();
  pending.splice(i,1);
  savePending(pending);
  loadPending();
}

function loadApproved(){
  approvedList.innerHTML="";
  getApproved().forEach((e,i)=>{
    approvedList.innerHTML+=`
    <div>
      ${e.title} - ${e.date}
      <button class="btn btn-danger" onclick="removeApproved(${i})">Remove</button>
    </div>`;
  });
}

function removeApproved(i){
  const approved=getApproved();
  approved.splice(i,1);
  saveApproved(approved);
  loadApproved();
}

function loadMembers(){
  memberGrid.innerHTML="";
  getMembers().forEach(m=>{
    const show=role==="admin"?{name:true,surname:true,title:true,number:true,photo:true}:m.visibility;
    let content="";
    if(show.photo && m.photo) content+=`<img src="${m.photo}">`;
    if(show.name||show.surname) content+=`<h4>${show.name?m.name:""} ${show.surname?m.surname:""}</h4>`;
    if(show.title) content+=`<p>${m.title}</p>`;
    if(show.number) content+=`<small>${m.number}</small>`;
    memberGrid.innerHTML+=`<div class="member-card">${content}
      ${role==="admin"?`<button class="btn" onclick="editMember(${m.id})">Edit</button>
      <button class="btn btn-danger" onclick="deleteMember(${m.id})">Delete</button>`:""}
    </div>`;
  });
}

</script>
</body>
</html>
